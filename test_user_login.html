<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Usuario Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test de Usuario y Login</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Informaci√≥n de localStorage</h3>
                <div id="localStorageInfo" class="bg-light p-3"></div>
                
                <h3 class="mt-4">Test Login</h3>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" value="admin@clinikdent.com">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contrase√±a</label>
                        <input type="password" class="form-control" id="password" value="admin123">
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
                
                <button class="btn btn-info mt-3" onclick="checkUserData()">Verificar Datos de Usuario</button>
                <button class="btn btn-warning mt-3" onclick="clearStorage()">Limpiar localStorage</button>
            </div>
            
            <div class="col-md-6">
                <h3>Informaci√≥n del Usuario Actual</h3>
                <div id="userInfo" class="bg-light p-3"></div>
                
                <h3 class="mt-4">Debug Console</h3>
                <div id="debugConsole" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar informaci√≥n de localStorage
        function showLocalStorageInfo() {
            const info = document.getElementById('localStorageInfo');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const userProfile = localStorage.getItem('userProfile');
            
            info.innerHTML = `
                <strong>Token:</strong> ${token ? token.substring(0, 50) + '...' : 'No hay token'}<br>
                <strong>User:</strong> ${user || 'No hay user'}<br>
                <strong>UserProfile:</strong> ${userProfile || 'No hay userProfile'}
            `;
        }

        // Funci√≥n para log personalizado
        function debugLog(message) {
            const console = document.getElementById('debugConsole');
            const timestamp = new Date().toLocaleTimeString();
            console.innerHTML += `[${timestamp}] ${message}<br>`;
            console.scrollTop = console.scrollHeight;
            console.log(message);
        }

        // Funci√≥n de login
        async function login(email, password) {
            try {
                debugLog('üîÑ Iniciando login...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                debugLog(`üì§ Respuesta del servidor: ${JSON.stringify(data)}`);

                if (response.ok) {
                    // Guardar token y usuario
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('userProfile', JSON.stringify(data.user));
                    
                    debugLog('‚úÖ Login exitoso');
                    showLocalStorageInfo();
                    checkUserData();
                } else {
                    debugLog(`‚ùå Error en login: ${data.message}`);
                }
            } catch (error) {
                debugLog(`‚ùå Error: ${error.message}`);
            }
        }

        // Funci√≥n para verificar datos de usuario
        async function checkUserData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    debugLog('‚ùå No hay token');
                    return;
                }

                debugLog('üîÑ Verificando datos de usuario...');
                
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                debugLog(`üì§ Datos del usuario: ${JSON.stringify(data)}`);

                if (response.ok) {
                    const userInfo = document.getElementById('userInfo');
                    userInfo.innerHTML = `
                        <strong>ID:</strong> ${data.id}<br>
                        <strong>Nombre:</strong> ${data.nombre}<br>
                        <strong>Apellido:</strong> ${data.apellido}<br>
                        <strong>Email:</strong> ${data.email}<br>
                        <strong>Rol:</strong> ${data.rol}<br>
                        <strong>Nombre Completo:</strong> ${data.nombre} ${data.apellido}
                    `;
                    
                    // Actualizar localStorage con datos completos
                    localStorage.setItem('user', JSON.stringify(data));
                    localStorage.setItem('userProfile', JSON.stringify(data));
                    
                    debugLog('‚úÖ Datos de usuario actualizados');
                } else {
                    debugLog(`‚ùå Error obteniendo usuario: ${data.message}`);
                }
            } catch (error) {
                debugLog(`‚ùå Error: ${error.message}`);
            }
        }

        // Funci√≥n para limpiar storage
        function clearStorage() {
            localStorage.clear();
            debugLog('üßπ localStorage limpiado');
            showLocalStorageInfo();
            document.getElementById('userInfo').innerHTML = 'No hay datos';
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            await login(email, password);
        });

        // Cargar informaci√≥n inicial
        showLocalStorageInfo();
        debugLog('üöÄ Test de usuario inicializado');
        
        // Si ya hay token, verificar datos
        if (localStorage.getItem('token')) {
            checkUserData();
        }
    </script>
</body>
</html>
