<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Nueva Contraseña - Clinikdent</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; }
        .card { border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class='container'>
        <div class='row justify-content-center'>
            <div class='col-md-5'>
                <div class='card p-4'>
                    <div class='card-body'>
                        <h3 class='text-center mb-4'> Nueva Contraseña</h3>
                        <form id='formNuevaPassword'>
                            <div class='mb-3'>
                                <label class='form-label'>Nueva Contraseña</label>
                                <input type='password' class='form-control' id='nuevaPassword' required>
                            </div>
                            <div class='mb-3'>
                                <label class='form-label'>Confirmar Contraseña</label>
                                <input type='password' class='form-control' id='confirmarPassword' required>
                            </div>
                            <button type='submit' class='btn btn-primary w-100'>Cambiar Contraseña</button>
                        </form>
                        <div id='mensaje' class='mt-3'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://xzlugnkzfdurczwwwimv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6bHVnbmt6ZmR1cmN6d3d3aW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MDQ0NDIsImV4cCI6MjA2MTA4MDQ0Mn0.BPf9NwqWhk2ZG7CiXwqPBUOoMWA87B0rOhqQWMZp-fU'
        );

        (async () => {
            console.log('🔍 URL completa:', window.location.href);
            console.log('🔍 Hash:', window.location.hash);
            
            const qs = new URLSearchParams(window.location.search);
            const emailParam = qs.get('email');
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const access_token = urlParams.get('access_token');
            const refresh_token = urlParams.get('refresh_token');
            const error_code = urlParams.get('error_code');
            const error_description = urlParams.get('error_description');

            console.log('🔍 Access Token presente:', !!access_token);
            console.log('🔍 Refresh Token presente:', !!refresh_token);
            
            if (error_code) {
                console.error('❌ Error de Supabase:', error_code, error_description);
                const emailInfo = emailParam ? `<div class='mt-2'><small>Correo detectado: <strong>${emailParam}</strong></small></div>` : '';
                const resendBtn = emailParam ? `<button id='btn-reenviar' class='btn btn-outline-primary btn-sm mt-2'>Reenviar enlace</button>` : '';
                document.getElementById('mensaje').innerHTML = `
                    <div class="alert alert-danger">❌ ${error_description || 'Link inválido o expirado'}
                        ${emailInfo}
                        ${resendBtn}
                    </div>`;
                if (emailParam) {
                    document.getElementById('btn-reenviar').addEventListener('click', async () => {
                        try {
                            const { error } = await supabaseClient.auth.resetPasswordForEmail(emailParam, {
                                redirectTo: `${window.location.origin}/nueva-password-supabase.html?email=${encodeURIComponent(emailParam)}`
                            });
                            if (error) throw error;
                            document.getElementById('mensaje').innerHTML = `<div class='alert alert-info'>📧 Te enviamos un nuevo enlace a <strong>${emailParam}</strong>. Revisa tu correo.</div>`;
                        } catch (e) {
                            document.getElementById('mensaje').innerHTML = `<div class='alert alert-danger'>❌ No se pudo reenviar el enlace: ${e.message}</div>`;
                        }
                    });
                }
                return;
            }

            if (!access_token) {
                console.error('❌ No se encontró access_token en la URL');
                document.getElementById('mensaje').innerHTML = '<div class="alert alert-danger">❌ Link inválido o expirado. Por favor, solicita un nuevo enlace de recuperación.</div>';
                setTimeout(() => window.location.href = '/index.html', 5000);
                return;
            }

            // Establecer la sesión local usando el token provisto en el hash de la URL
            try {
                console.log('🔐 Intentando establecer sesión...');
                const { data, error } = await supabaseClient.auth.setSession({ access_token, refresh_token });
                if (error) {
                    console.error('❌ Error setting session from URL token:', error);
                    document.getElementById('mensaje').innerHTML = `<div class="alert alert-danger">❌ ${error.message || 'Link inválido o expirado'}. Por favor, solicita un nuevo enlace.</div>`;
                    setTimeout(() => window.location.href = '/index.html', 5000);
                    return;
                }
                console.log('✅ Sesión establecida desde token de recuperación:', data.session?.user?.email);
                document.getElementById('mensaje').innerHTML = '<div class="alert alert-success">✅ Sesión validada. Ahora puedes cambiar tu contraseña.</div>';
            } catch (err) {
                console.error('❌ Excepción al setear session:', err);
                document.getElementById('mensaje').innerHTML = `<div class="alert alert-danger">❌ Error: ${err.message}. Por favor, solicita un nuevo enlace.</div>`;
                setTimeout(() => window.location.href = '/index.html', 5000);
                return;
            }
        })();

        document.getElementById('formNuevaPassword').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevaPassword = document.getElementById('nuevaPassword').value;
            const confirmarPassword = document.getElementById('confirmarPassword').value;
            
            if (nuevaPassword !== confirmarPassword) {
                document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-warning\">Las contraseñas no coinciden</div>';
                return;
            }
            
            if (nuevaPassword.length < 6) {
                document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-warning\">La contraseña debe tener al menos 6 caracteres</div>';
                return;
            }
            
            try {
                // Actualizar la contraseña en Supabase Auth (usuario autenticado por el token)
                console.log('🔐 Actualizando contraseña en Supabase Auth...');
                const { data: updateData, error: updateError } = await supabaseClient.auth.updateUser({ password: nuevaPassword });
                if (updateError) {
                    console.error('❌ Error actualizando en Supabase:', updateError);
                    throw new Error(updateError.message || 'Error actualizando contraseña en Supabase');
                }

                console.log('✅ Contraseña actualizada en Supabase Auth');

                // Luego sincronizar el hash en PostgreSQL a través del backend
                const correo = updateData?.user?.email;
                if (!correo) {
                    throw new Error('No se pudo obtener el correo del usuario');
                }

                console.log('💾 Sincronizando con PostgreSQL...');
                const response = await fetch('/api/auth/actualizar-password-supabase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ correo, nueva_password: nuevaPassword })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('✅ Sincronización completada');
                    document.getElementById('mensaje').innerHTML = '<div class="alert alert-success">✅ Contraseña actualizada correctamente. Redirigiendo al login...</div>';
                    
                    // Cerrar sesión de Supabase para forzar nuevo login
                    await supabaseClient.auth.signOut();
                    
                    // Redirigir al login después de 2 segundos
                    setTimeout(() => {
                        window.location.href = '/index.html?password_reset=success';
                    }, 2000);
                } else {
                    throw new Error(data.msg || 'Error al sincronizar contraseña en el servidor');
                }

            } catch (error) {
                console.error('❌ Error completo:', error);
                document.getElementById('mensaje').innerHTML = '<div class="alert alert-danger">❌ Error al actualizar contraseña: ' + error.message + '</div>';
            }
        });
    </script>
</body>
</html>
