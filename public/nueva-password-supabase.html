<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Nueva Contraseña - Clinikdent</title>
    <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css' rel='stylesheet'>
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; }
        .card { border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class='container'>
        <div class='row justify-content-center'>
            <div class='col-md-5'>
                <div class='card p-4'>
                    <div class='card-body'>
                        <h3 class='text-center mb-4'> Nueva Contraseña</h3>
                        <form id='formNuevaPassword'>
                            <div class='mb-3'>
                                <label class='form-label'>Nueva Contraseña</label>
                                <input type='password' class='form-control' id='nuevaPassword' required>
                            </div>
                            <div class='mb-3'>
                                <label class='form-label'>Confirmar Contraseña</label>
                                <input type='password' class='form-control' id='confirmarPassword' required>
                            </div>
                            <button type='submit' class='btn btn-primary w-100'>Cambiar Contraseña</button>
                        </form>
                        <div id='mensaje' class='mt-3'></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://xzlugnkzfdurczwwwimv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh6bHVnbmt6ZmR1cmN6d3d3aW12Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MDQ0NDIsImV4cCI6MjA2MTA4MDQ0Mn0.BPf9NwqWhk2ZG7CiXwqPBUOoMWA87B0rOhqQWMZp-fU'
        );

        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const access_token = urlParams.get('access_token');

        if (!access_token) {
            document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-danger\">Link inválido o expirado</div>';
            setTimeout(() => window.location.href = '/index.html', 3000);
        }

        document.getElementById('formNuevaPassword').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nuevaPassword = document.getElementById('nuevaPassword').value;
            const confirmarPassword = document.getElementById('confirmarPassword').value;
            
            if (nuevaPassword !== confirmarPassword) {
                document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-warning\">Las contraseñas no coinciden</div>';
                return;
            }
            
            if (nuevaPassword.length < 6) {
                document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-warning\">La contraseña debe tener al menos 6 caracteres</div>';
                return;
            }
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (!session) {
                    throw new Error('No hay sesión activa');
                }
                
                const response = await fetch('http://localhost:3001/api/auth/actualizar-password-supabase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        correo: session.user.email,
                        nueva_password: nuevaPassword
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-success\"> Contraseña actualizada correctamente</div>';
                    setTimeout(() => window.location.href = '/index.html', 2000);
                } else {
                    throw new Error(data.msg || 'Error al actualizar');
                }
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('mensaje').innerHTML = '<div class=\"alert alert-danger\">Error al actualizar contraseña</div>';
            }
        });
    </script>
</body>
</html>
