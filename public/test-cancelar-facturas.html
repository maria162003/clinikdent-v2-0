<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Cancelar Facturas Pendientes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="bi bi-receipt"></i> Test - Cancelar Facturas Pendientes</h3>
                        <p class="mb-0 text-muted">Funcionalidad para cancelar facturas que se crearon por error al dar "Cancelar" en el pago</p>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>üë§ Usuario de Prueba</h5>
                                <p><strong>Paciente:</strong> juan perez (ID: 3)</p>
                                <p><strong>Email:</strong> juan@gmail.com</p>
                                <p><strong>Password:</strong> 123456</p>
                                
                                <button class="btn btn-primary" onclick="simularLoginPaciente()">
                                    <i class="bi bi-person-check"></i> Simular Login Paciente
                                </button>
                                
                                <button class="btn btn-success" onclick="abrirDashboardPaciente()" id="btnDashboard" disabled>
                                    <i class="bi bi-speedometer2"></i> Abrir Dashboard Paciente
                                </button>
                            </div>
                            
                            <div class="col-md-6">
                                <h5>üß™ Pruebas de API</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info" onclick="crearFacturaPrueba()" id="btnCrear" disabled>
                                        <i class="bi bi-plus-circle"></i> Crear Factura de Prueba
                                    </button>
                                    <button class="btn btn-warning" onclick="verFacturasPendientes()" id="btnVer" disabled>
                                        <i class="bi bi-list-ul"></i> Ver Facturas Pendientes
                                    </button>
                                    <button class="btn btn-danger" onclick="testCancelarFactura()" id="btnCancelar" disabled>
                                        <i class="bi bi-x-circle"></i> Test Cancelar Factura
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h5>üìã Informaci√≥n del Problema</h5>
                            <div class="alert alert-info">
                                <h6><i class="bi bi-info-circle"></i> Problema Original:</h6>
                                <ul class="mb-0">
                                    <li>El paciente da clic en "Pagar" por un servicio</li>
                                    <li>En el modal de MercadoPago, da clic en "Cancelar"</li>
                                    <li>Se crea una factura pendiente autom√°ticamente</li>
                                    <li>El paciente no ten√≠a forma de cancelar esa factura si no quer√≠a el servicio</li>
                                </ul>
                            </div>
                            
                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> Soluci√≥n Implementada:</h6>
                                <ul class="mb-0">
                                    <li>‚úÖ Nuevo endpoint: <code>DELETE /api/mercadopago/cancelar-factura/:id</code></li>
                                    <li>‚úÖ Bot√≥n "Cancelar Factura" en cada factura pendiente</li>
                                    <li>‚úÖ Confirmaci√≥n antes de cancelar</li>
                                    <li>‚úÖ Estado se cambia a 'cancelled' en la base de datos</li>
                                    <li>‚úÖ Actualizaci√≥n autom√°tica de la vista</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-4" id="statusArea"></div>
                        <div class="mt-3" id="resultArea"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        function simularLoginPaciente() {
            currentUser = {
                id: 3,
                nombre: 'juan',
                apellido: 'perez',
                email: 'juan@gmail.com',
                rol: 'paciente'
            };
            
            localStorage.setItem('user', JSON.stringify(currentUser));
            localStorage.setItem('userData', JSON.stringify(currentUser));
            localStorage.setItem('userToken', 'test-token-paciente');
            
            document.getElementById('statusArea').innerHTML = `
                <div class="alert alert-success">
                    ‚úÖ Sesi√≥n de paciente simulada correctamente<br>
                    üìù Usuario: ${currentUser.nombre} ${currentUser.apellido} (ID: ${currentUser.id})
                </div>
            `;
            
            // Habilitar botones
            document.getElementById('btnDashboard').disabled = false;
            document.getElementById('btnCrear').disabled = false;
            document.getElementById('btnVer').disabled = false;
            document.getElementById('btnCancelar').disabled = false;
        }

        function abrirDashboardPaciente() {
            window.open('/dashboard-paciente.html', '_blank');
        }

        async function crearFacturaPrueba() {
            try {
                document.getElementById('statusArea').innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Creando factura de prueba...
                    </div>
                `;

                const response = await fetch('/api/mercadopago/crear-preferencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'user-id': currentUser.id
                    },
                    body: JSON.stringify({
                        titulo: 'Limpieza Dental - Test',
                        descripcion: 'Factura de prueba para testing de cancelaci√≥n',
                        precio: 150000,
                        cantidad: 1,
                        usuario_id: currentUser.id
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('statusArea').innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Factura de prueba creada exitosamente<br>
                            <strong>ID:</strong> ${data.transaccion_id}<br>
                            <strong>Monto:</strong> $150,000 COP
                        </div>
                    `;
                } else {
                    throw new Error(data.error || 'Error al crear factura');
                }
                
            } catch (error) {
                document.getElementById('statusArea').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error al crear factura: ${error.message}
                    </div>
                `;
            }
        }

        async function verFacturasPendientes() {
            try {
                const response = await fetch(`/api/mercadopago/transacciones?usuario_id=${currentUser.id}`, {
                    headers: {
                        'user-id': currentUser.id
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    const facturasPendientes = data.transacciones.filter(t => t.estado === 'pending');
                    
                    let html = `
                        <h6>üìã Facturas Pendientes Encontradas: ${facturasPendientes.length}</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Concepto</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                        <th>Fecha</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (facturasPendientes.length === 0) {
                        html += `<tr><td colspan="6" class="text-center text-muted">No hay facturas pendientes</td></tr>`;
                    } else {
                        facturasPendientes.forEach(factura => {
                            html += `
                                <tr>
                                    <td>${factura.id}</td>
                                    <td>${factura.concepto || 'Servicio dental'}</td>
                                    <td>$${new Intl.NumberFormat('es-CO').format(factura.monto)}</td>
                                    <td><span class="badge bg-warning">${factura.estado}</span></td>
                                    <td>${new Date(factura.fecha_creacion).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="cancelarFacturaId(${factura.id})">
                                            <i class="bi bi-x"></i> Cancelar
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `</tbody></table></div>`;
                    
                    document.getElementById('resultArea').innerHTML = html;
                } else {
                    throw new Error(data.error || 'Error al obtener facturas');
                }
                
            } catch (error) {
                document.getElementById('resultArea').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        async function cancelarFacturaId(facturaId) {
            try {
                const confirmacion = confirm(`¬øCancelar factura ID ${facturaId}?`);
                if (!confirmacion) return;

                const response = await fetch(`/api/mercadopago/cancelar-factura/${facturaId}?usuario_id=${currentUser.id}`, {
                    method: 'DELETE',
                    headers: {
                        'user-id': currentUser.id
                    }
                });

                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('statusArea').innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Factura ${facturaId} cancelada exitosamente
                        </div>
                    `;
                    // Actualizar lista
                    verFacturasPendientes();
                } else {
                    throw new Error(data.error || 'Error al cancelar');
                }
                
            } catch (error) {
                document.getElementById('statusArea').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        async function testCancelarFactura() {
            // Primero obtener facturas pendientes
            try {
                const response = await fetch(`/api/mercadopago/transacciones?usuario_id=${currentUser.id}`, {
                    headers: { 'user-id': currentUser.id }
                });
                const data = await response.json();
                const facturasPendientes = data.transacciones.filter(t => t.estado === 'pending');
                
                if (facturasPendientes.length === 0) {
                    document.getElementById('statusArea').innerHTML = `
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è No hay facturas pendientes para cancelar. Crea una factura de prueba primero.
                        </div>
                    `;
                    return;
                }
                
                // Cancelar la primera factura pendiente
                const factura = facturasPendientes[0];
                await cancelarFacturaId(factura.id);
                
            } catch (error) {
                document.getElementById('statusArea').innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
            }
        }

        // Verificar si hay sesi√≥n al cargar
        window.onload = function() {
            const user = localStorage.getItem('user');
            if (user) {
                currentUser = JSON.parse(user);
                if (currentUser.id === 3) {
                    document.getElementById('btnDashboard').disabled = false;
                    document.getElementById('btnCrear').disabled = false;
                    document.getElementById('btnVer').disabled = false;
                    document.getElementById('btnCancelar').disabled = false;
                    document.getElementById('statusArea').innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Sesi√≥n detectada: ${currentUser.nombre} ${currentUser.apellido}
                        </div>
                    `;
                }
            }
        };
    </script>
</body>
</html>
