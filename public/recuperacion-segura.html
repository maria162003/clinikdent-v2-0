<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperación Segura - ClinikDent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .security-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            max-width: 450px;
            width: 100%;
        }
        .security-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .security-body {
            padding: 30px;
        }
        .codigo-input {
            font-size: 1.5em;
            text-align: center;
            letter-spacing: 0.5em;
            font-weight: bold;
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
        }
        .contador-tiempo {
            font-size: 1.2em;
            font-weight: bold;
            color: #dc3545;
            text-align: center;
            margin: 15px 0;
        }
        .paso-completado {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .paso-activo {
            border: 2px solid #007bff;
            background-color: #e7f3ff;
        }
        .intentos-restantes {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-size: 0.9em;
        }
        .bloqueo-alerta {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="security-card">
            <div class="security-header">
                <h2><i class="fas fa-shield-alt"></i> Recuperación Segura</h2>
                <p class="mb-0">Sistema de verificación de doble factor</p>
            </div>
            
            <div class="security-body">
                <!-- Alerta de bloqueo -->
                <div id="alertaBloqueo" class="bloqueo-alerta d-none">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div id="mensajeBloqueo"></div>
                </div>
                
                <!-- Paso 1: Solicitar código -->
                <div id="paso1" class="paso-activo">
                    <h4><i class="fas fa-user-check"></i> Paso 1: Verificación de Identidad</h4>
                    <p class="text-muted">Ingrese sus datos para recibir un código de seguridad</p>
                    
                    <form id="formSolicitarCodigo">
                        <div class="mb-3">
                            <label for="correo" class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="correo" required>
                        </div>
                        <div class="mb-3">
                            <label for="numeroDocumento" class="form-label">Número de Documento</label>
                            <input type="text" class="form-control" id="numeroDocumento" required>
                        </div>
                        <div id="intentosRestantes1" class="intentos-restantes d-none"></div>
                        <button type="submit" class="btn btn-primary w-100" id="btnSolicitarCodigo">
                            <i class="fas fa-paper-plane"></i> Enviar Código de Seguridad
                        </button>
                    </form>
                </div>
                
                <!-- Paso 2: Validar código -->
                <div id="paso2" class="d-none">
                    <div class="paso-completado">
                        <i class="fas fa-check-circle"></i> Código enviado exitosamente
                    </div>
                    
                    <h4><i class="fas fa-key"></i> Paso 2: Código de Seguridad</h4>
                    <p class="text-muted">Ingrese el código de 4 dígitos que recibió por correo</p>
                    
                    <div id="contadorTiempo" class="contador-tiempo"></div>
                    
                    <form id="formValidarCodigo">
                        <div class="mb-3">
                            <label for="codigoSeguridad" class="form-label">Código de Seguridad</label>
                            <input type="text" class="form-control codigo-input" id="codigoSeguridad" 
                                   maxlength="4" placeholder="1234" required>
                        </div>
                        <div id="intentosRestantes2" class="intentos-restantes d-none"></div>
                        <button type="submit" class="btn btn-success w-100" id="btnValidarCodigo">
                            <i class="fas fa-unlock"></i> Validar Código
                        </button>
                    </form>
                    
                    <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="btnNuevoCodigo">
                        <i class="fas fa-redo"></i> Solicitar Nuevo Código
                    </button>
                </div>
                
                <!-- Paso 3: Confirmación -->
                <div id="paso3" class="d-none">
                    <div class="paso-completado">
                        <i class="fas fa-check-circle"></i> Código validado exitosamente
                    </div>
                    
                    <h4><i class="fas fa-check-double"></i> Recuperación Exitosa</h4>
                    <p class="text-success">Se ha enviado su nueva contraseña temporal a su correo electrónico.</p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Importante:</strong> Por seguridad, cambie esta contraseña temporal después de iniciar sesión.
                    </div>
                    
                    <a href="/" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> Ir a Iniciar Sesión
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let tiempoExpiracion = null;
        let intervaloContador = null;
        
        // Elementos del DOM
        const paso1 = document.getElementById('paso1');
        const paso2 = document.getElementById('paso2');
        const paso3 = document.getElementById('paso3');
        const alertaBloqueo = document.getElementById('alertaBloqueo');
        const mensajeBloqueo = document.getElementById('mensajeBloqueo');
        const formSolicitarCodigo = document.getElementById('formSolicitarCodigo');
        const formValidarCodigo = document.getElementById('formValidarCodigo');
        const btnSolicitarCodigo = document.getElementById('btnSolicitarCodigo');
        const btnValidarCodigo = document.getElementById('btnValidarCodigo');
        const btnNuevoCodigo = document.getElementById('btnNuevoCodigo');
        const contadorTiempo = document.getElementById('contadorTiempo');
        const intentosRestantes1 = document.getElementById('intentosRestantes1');
        const intentosRestantes2 = document.getElementById('intentosRestantes2');
        
        // Paso 1: Solicitar código
        formSolicitarCodigo.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const correo = document.getElementById('correo').value;
            const numeroDocumento = document.getElementById('numeroDocumento').value;
            
            btnSolicitarCodigo.disabled = true;
            btnSolicitarCodigo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
            
            try {
                const response = await fetch('/api/seguridad/solicitar-codigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correo, numero_documento: numeroDocumento })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Éxito - mostrar paso 2
                    mostrarPaso2(data.vigencia_minutos);
                    mostrarMensaje('success', data.msg);
                } else {
                    // Error
                    if (data.bloqueado) {
                        mostrarBloqueo(data.msg, data.tiempo_restante);
                    } else {
                        mostrarMensaje('error', data.msg);
                        if (data.intentos_restantes) {
                            mostrarIntentosRestantes(intentosRestantes1, data.intentos_restantes);
                        }
                    }
                }
            } catch (error) {
                mostrarMensaje('error', 'Error de conexión. Intente nuevamente.');
            } finally {
                btnSolicitarCodigo.disabled = false;
                btnSolicitarCodigo.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Código de Seguridad';
            }
        });
        
        // Paso 2: Validar código
        formValidarCodigo.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const correo = document.getElementById('correo').value;
            const numeroDocumento = document.getElementById('numeroDocumento').value;
            const codigo = document.getElementById('codigoSeguridad').value;
            
            btnValidarCodigo.disabled = true;
            btnValidarCodigo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Validando...';
            
            try {
                const response = await fetch('/api/seguridad/validar-codigo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ correo, numero_documento: numeroDocumento, codigo })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Éxito - mostrar paso 3
                    mostrarPaso3();
                    mostrarMensaje('success', data.msg);
                } else {
                    // Error
                    mostrarMensaje('error', data.msg);
                    if (data.intentos_restantes !== undefined) {
                        mostrarIntentosRestantes(intentosRestantes2, data.intentos_restantes);
                    }
                }
            } catch (error) {
                mostrarMensaje('error', 'Error de conexión. Intente nuevamente.');
            } finally {
                btnValidarCodigo.disabled = false;
                btnValidarCodigo.innerHTML = '<i class="fas fa-unlock"></i> Validar Código';
            }
        });
        
        // Solicitar nuevo código
        btnNuevoCodigo.addEventListener('click', () => {
            volverPaso1();
        });
        
        // Solo permitir números en el código
        document.getElementById('codigoSeguridad').addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });
        
        function mostrarPaso2(vigenciaMinutos) {
            paso1.classList.remove('paso-activo');
            paso1.classList.add('d-none');
            paso2.classList.remove('d-none');
            paso2.classList.add('paso-activo');
            
            // Iniciar contador de tiempo
            tiempoExpiracion = new Date(Date.now() + vigenciaMinutos * 60000);
            iniciarContadorTiempo();
        }
        
        function mostrarPaso3() {
            paso2.classList.remove('paso-activo');
            paso2.classList.add('d-none');
            paso3.classList.remove('d-none');
            
            // Detener contador
            if (intervaloContador) {
                clearInterval(intervaloContador);
            }
        }
        
        function volverPaso1() {
            paso2.classList.remove('paso-activo');
            paso2.classList.add('d-none');
            paso1.classList.remove('d-none');
            paso1.classList.add('paso-activo');
            
            // Limpiar campos
            document.getElementById('codigoSeguridad').value = '';
            intentosRestantes2.classList.add('d-none');
            
            // Detener contador
            if (intervaloContador) {
                clearInterval(intervaloContador);
            }
        }
        
        function iniciarContadorTiempo() {
            function actualizarContador() {
                const ahora = new Date();
                const tiempoRestante = tiempoExpiracion - ahora;
                
                if (tiempoRestante <= 0) {
                    contadorTiempo.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Código expirado';
                    clearInterval(intervaloContador);
                    return;
                }
                
                const minutos = Math.floor(tiempoRestante / 60000);
                const segundos = Math.floor((tiempoRestante % 60000) / 1000);
                
                contadorTiempo.innerHTML = `<i class="fas fa-clock"></i> Tiempo restante: ${minutos}:${segundos.toString().padStart(2, '0')}`;
            }
            
            actualizarContador();
            intervaloContador = setInterval(actualizarContador, 1000);
        }
        
        function mostrarBloqueo(mensaje, tiempoRestante) {
            alertaBloqueo.classList.remove('d-none');
            mensajeBloqueo.innerHTML = mensaje;
            
            // Ocultar formularios
            paso1.classList.add('d-none');
            paso2.classList.add('d-none');
        }
        
        function mostrarIntentosRestantes(elemento, intentos) {
            if (intentos > 0) {
                elemento.classList.remove('d-none');
                elemento.innerHTML = `<i class="fas fa-exclamation-circle"></i> Intentos restantes: ${intentos}`;
            }
        }
        
        function mostrarMensaje(tipo, mensaje) {
            // Crear toast de Bootstrap para mostrar mensajes
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '9999';
            
            const colorClass = tipo === 'success' ? 'bg-success' : 'bg-danger';
            
            toastContainer.innerHTML = `
                <div class="toast ${colorClass} text-white" role="alert">
                    <div class="toast-body">
                        <i class="fas fa-${tipo === 'success' ? 'check' : 'exclamation-triangle'}"></i>
                        ${mensaje}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toastContainer);
            
            const toast = new bootstrap.Toast(toastContainer.querySelector('.toast'));
            toast.show();
            
            // Limpiar después de 5 segundos
            setTimeout(() => {
                document.body.removeChild(toastContainer);
            }, 5000);
        }
    </script>
</body>
</html>