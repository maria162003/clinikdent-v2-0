<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test MercadoPago - Clinikdent</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #009ee3;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #0080b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-accounts {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .payment-link {
            display: inline-block;
            background: #00d4aa;
            color: white;
            padding: 15px 25px;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: bold;
        }
        .payment-link:hover {
            background: #00b894;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶∑ Test MercadoPago - Clinikdent</h1>
        
        <div class="test-accounts">
            <h3>üìã Cuentas de Prueba (Colombia)</h3>
            <p><strong>Vendedor:</strong> TESTUSER8312 | Contrase√±a: FONanTMAuV</p>
            <p><strong>Comprador:</strong> TESTUSER4549 | Contrase√±a: viuWGfcPEp</p>
            <p><em>Usa estas credenciales para probar los pagos</em></p>
        </div>

        <form id="paymentForm">
            <div class="form-group">
                <label for="titulo">T√≠tulo del Servicio:</label>
                <select id="titulo" required>
                    <option value="">Selecciona un servicio</option>
                    <option value="Consulta General">Consulta General - $80,000</option>
                    <option value="Limpieza Dental">Limpieza Dental - $120,000</option>
                    <option value="Extracci√≥n">Extracci√≥n - $150,000</option>
                    <option value="Ortodoncia">Ortodoncia - $2,500,000</option>
                    <option value="Blanqueamiento">Blanqueamiento - $300,000</option>
                </select>
            </div>

            <div class="form-group">
                <label for="precio">Precio (COP):</label>
                <input type="number" id="precio" required min="1000" step="1000" placeholder="80000">
            </div>

            <div class="form-group">
                <label for="descripcion">Descripci√≥n:</label>
                <textarea id="descripcion" rows="3" placeholder="Detalles del servicio dental..."></textarea>
            </div>

            <div class="form-group">
                <label for="usuario_id">ID Usuario (opcional):</label>
                <input type="text" id="usuario_id" placeholder="3" value="3">
            </div>

            <button type="submit">üí≥ Crear Pago</button>
            <button type="button" onclick="testAPI()">üîß Test API</button>
        </form>

        <div id="result" class="result"></div>
    </div>

    <script>
        // Precios predefinidos
        const precios = {
            'Consulta General': 80000,
            'Limpieza Dental': 120000,
            'Extracci√≥n': 150000,
            'Ortodoncia': 2500000,
            'Blanqueamiento': 300000
        };

        // Actualizar precio cuando se selecciona un servicio
        document.getElementById('titulo').addEventListener('change', function() {
            const servicio = this.value;
            const precioInput = document.getElementById('precio');
            const descripcionInput = document.getElementById('descripcion');
            
            if (precios[servicio]) {
                precioInput.value = precios[servicio];
                descripcionInput.value = `${servicio} - Cl√≠nica Dental Clinikdent`;
            }
        });

        // Manejar env√≠o del formulario
        document.getElementById('paymentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                titulo: document.getElementById('titulo').value,
                precio: document.getElementById('precio').value,
                descripcion: document.getElementById('descripcion').value,
                usuario_id: document.getElementById('usuario_id').value || null
            };

            console.log('üì§ Enviando datos:', formData);
            showResult('Creando preferencia de pago...', 'success');

            try {
                const response = await fetch('/api/mercadopago/crear-preferencia', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                console.log('üì• Respuesta:', data);

                if (data.success) {
                    showResult(`
                        <h3>‚úÖ Preferencia creada exitosamente</h3>
                        <p><strong>ID:</strong> ${data.preference_id}</p>
                        <p><strong>Transacci√≥n:</strong> ${data.transaccion_id || 'N/A'}</p>
                        
                        <h4>üîó Enlaces de Pago:</h4>
                        <a href="${data.init_point}" target="_blank" class="payment-link">
                            üí≥ Pagar Ahora (Producci√≥n)
                        </a>
                        
                        ${data.sandbox_init_point ? `
                            <br><a href="${data.sandbox_init_point}" target="_blank" class="payment-link" style="background: #ff7675;">
                                üß™ Pagar (Pruebas)
                            </a>
                        ` : ''}
                        
                        <h4>üìä Datos de Prueba:</h4>
                        <p><strong>Vendedor ID:</strong> ${data.test_data.seller_id}</p>
                        <p><strong>Usuario Comprador:</strong> ${data.test_data.buyer_user}</p>
                        <p><strong>Contrase√±a:</strong> ${data.test_data.buyer_password}</p>
                    `, 'success');
                } else {
                    showResult(`‚ùå Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                showResult(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        });

        // Test de la API
        async function testAPI() {
            showResult('üîß Probando conexi√≥n con API...', 'success');
            
            try {
                const response = await fetch('/api/mercadopago/');
                const data = await response.json();
                
                showResult(`
                    <h3>‚úÖ API funcionando correctamente</h3>
                    <p><strong>Versi√≥n:</strong> ${data.version}</p>
                    <p><strong>Sandbox:</strong> ${data.testing.sandbox ? 'S√≠' : 'No'}</p>
                    <p><strong>Endpoints disponibles:</strong></p>
                    <ul>
                        ${Object.entries(data.endpoints).map(([key, value]) => 
                            `<li><strong>${key}:</strong> ${value}</li>`
                        ).join('')}
                    </ul>
                `, 'success');
            } catch (error) {
                showResult(`‚ùå Error conectando con la API: ${error.message}`, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
            
            // Scroll al resultado
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Test inicial al cargar la p√°gina
        window.addEventListener('load', function() {
            testAPI();
        });
    </script>
</body>
</html>
