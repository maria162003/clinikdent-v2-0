<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Anti-Duplicaci√≥n - ClinikDent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-4">
        <h2><i class="bi bi-bug"></i> Test Anti-Duplicaci√≥n de Paginaci√≥n</h2>
        
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-shield-check"></i> Monitor de Inicializaciones</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Contador de Inicializaciones:</h6>
                        <ul id="contadores" class="list-unstyled">
                            <li><strong>Usuarios:</strong> <span id="count-usuarios" class="badge bg-secondary">0</span></li>
                            <li><strong>Citas:</strong> <span id="count-citas" class="badge bg-secondary">0</span></li>
                            <li><strong>Evaluaciones:</strong> <span id="count-evaluaciones" class="badge bg-secondary">0</span></li>
                            <li><strong>FAQs:</strong> <span id="count-faqs" class="badge bg-secondary">0</span></li>
                            <li><strong>Reportes:</strong> <span id="count-reportes" class="badge bg-secondary">0</span></li>
                            <li><strong>Pagos:</strong> <span id="count-pagos" class="badge bg-secondary">0</span></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Acciones de Test:</h6>
                        <div class="d-grid gap-2">
                            <button id="test-usuarios" class="btn btn-primary btn-sm">Test Usuarios</button>
                            <button id="test-citas" class="btn btn-info btn-sm">Test Citas</button>
                            <button id="test-evaluaciones" class="btn btn-success btn-sm">Test Evaluaciones</button>
                            <button id="reset-counters" class="btn btn-warning btn-sm">Reset Contadores</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="bi bi-list-check"></i> Log de Actividad</h5>
            </div>
            <div class="card-body">
                <div id="log" class="border rounded p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                    <small class="text-muted">Log iniciado...</small>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/pagination-system.js"></script>
    
    <script>
        // Contadores de inicializaciones
        const counters = {
            usuarios: 0,
            citas: 0,
            evaluaciones: 0,
            faqs: 0,
            reportes: 0,
            pagos: 0
        };

        // Funci√≥n para a√±adir al log
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<small><span class="text-muted">[${time}]</span> <span class="text-${type}">${message}</span></small>`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Interceptar la funci√≥n de inicializaci√≥n para contar las llamadas
        const originalInitializePagination = window.initializePaginationAdmin;
        
        window.initializePaginationAdmin = function(section) {
            // Incrementar contador
            if (counters.hasOwnProperty(section)) {
                counters[section]++;
                
                // Actualizar UI
                const badge = document.getElementById(`count-${section}`);
                if (badge) {
                    badge.textContent = counters[section];
                    badge.className = counters[section] > 1 ? 'badge bg-danger' : 'badge bg-success';
                }
                
                // Log
                const isDuplicate = counters[section] > 1;
                addLog(`üîÑ Inicializaci√≥n ${section} (#${counters[section]})${isDuplicate ? ' ‚ö†Ô∏è DUPLICADA' : ''}`, 
                      isDuplicate ? 'danger' : 'success');
            }
            
            // Llamar a la funci√≥n original
            if (originalInitializePagination) {
                return originalInitializePagination.call(this, section);
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ Test anti-duplicaci√≥n iniciado', 'info');
            
            // Test usuarios
            document.getElementById('test-usuarios').addEventListener('click', function() {
                addLog('üß™ Ejecutando test de usuarios...', 'primary');
                
                // Simular m√∫ltiples inicializaciones como antes del fix
                setTimeout(() => window.initializePaginationAdmin('usuarios'), 100);
                setTimeout(() => window.initializePaginationAdmin('usuarios'), 200);
            });

            // Test citas
            document.getElementById('test-citas').addEventListener('click', function() {
                addLog('üß™ Ejecutando test de citas...', 'primary');
                
                setTimeout(() => window.initializePaginationAdmin('citas'), 100);
                setTimeout(() => window.initializePaginationAdmin('citas'), 200);
            });

            // Test evaluaciones
            document.getElementById('test-evaluaciones').addEventListener('click', function() {
                addLog('üß™ Ejecutando test de evaluaciones...', 'primary');
                
                setTimeout(() => window.initializePaginationAdmin('evaluaciones'), 100);
                setTimeout(() => window.initializePaginationAdmin('evaluaciones'), 200);
            });

            // Reset contadores
            document.getElementById('reset-counters').addEventListener('click', function() {
                Object.keys(counters).forEach(key => {
                    counters[key] = 0;
                    const badge = document.getElementById(`count-${key}`);
                    if (badge) {
                        badge.textContent = '0';
                        badge.className = 'badge bg-secondary';
                    }
                });
                
                document.getElementById('log').innerHTML = '<small class="text-muted">Log reiniciado...</small>';
                addLog('üîÑ Contadores reiniciados', 'warning');
            });

            addLog('‚úÖ Test configurado correctamente', 'success');
        });
    </script>
</body>
</html>